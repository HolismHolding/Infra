#!/bin/bash

. /HolismHolding/Infra/Scripts/Message.sh

function SetJsConfig()
{
    declare -A Aliases
    while IFS=$'\t' read Alias Path
    do
        ReplacedAlias="${Alias/\/$Organization\/$Repository\/components\//}"
        ReplacedAlias="${ReplacedAlias/\//}"
        ReplacedPath="${Path/\/$Organization\/$Repository\/components\//}"
        echo $ReplacedAlias
        echo $ReplacedPath
        Aliases[$ReplacedAlias]=$ReplacedPath
    done <<< "$(find /$Organization/$Repository/components -mindepth 1 -type d -printf '%p\tcomponents/%p/Exports\n')"
    jo -p compilerOptions[baseUrl]=. compilerOptions[paths]="$(jo -p a ${Aliases[@]})"
}

function SetExports()
{
    Content=""
    while read FileName
    do
        FileNameWithoutExtension="${FileName/.js/}"
        Content="${Content}import $FileNameWithoutExtension from './$FileNameWithoutExtension'\n"
    done <<< "$(find $Directory -mindepth 1 -maxdepth 1 -type f -name "*.js" -not -name 'Exports.js' -printf '%f\n' | sort)"
    Content="${Content}\n"
    while read FileName
    do
        FileNameWithoutExtension="${FileName/.js/}"
        Content="${Content}export { $FileNameWithoutExtension }\n"
    done <<< "$(find $Directory -mindepth 1 -maxdepth 1 -type f -name "*.js" -not -name 'Exports.js' -printf '%f\n' | sort)"
    if [ -f $Directory/Exports.js ]; then
        CurrentContent=$(cat $Directory/Exports.js)
        if [[ $(echo $CurrentContent | xargs) != $(echo $Content | xargs) ]]; then
            Info "Updating Exports.js of $Directory"
            echo -e $Content > $Directory/Exports.js
        else
            Success 'equal'
        fi
    else
        Info "Creating Exports.js for the first time in $Directory"
        echo -e $Content > $Directory/Exports.js
    fi
}

SetExports

inotifywait -m /$Organization/$Repository/components -r \
-e modify \
-e move \
-e create \
-e delete \
--exclude "Exports.js" |
while IFS=' ' read Directory Event File
do
    export Directory
    export Event
    export File
    # SetJsConfig
    SetExports
done
